# Lab 3

## Lab 03-01

### 1. What are this malware’s imports and strings?

The binary seems to be packed as viewed in PE-bear. Then using PEiD, it appears that the binary is packed with a tool called PEncrypt. When viewed with PE-Bear, there seems to be one import only. But after executing the binary, more imports can be viewed using the process hacker.

![lab03-01 strings](lab03_01_exe_strings.png)

![lab03-01 imports](lab03_01_exe_imports.png)

![lab03-01 packed](lab03_01_exe_packed.png)

![lab03-01 unpacked imports](lab03_01_exe_unpacked_imports.png)

<br/><br/>

### 2. What are the malware’s host-based indicators?

There is three host-based IOC that could be used to detect malware activity. The malware would create a mutex named WinVMX32. It would also add a value to the HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run registry with the key named VideoDriver.

![lab03-01 mutex](lab03_01_exe_mutex.png)

![lab03-01 persistence IOC](lab03_01_exe_persistence_host_ioc.png)

![lab03-01 Video Driver key added](lab03_01_exe_video_driver_host_ioc.png)

![lab03-01 RegShot image of added key value](lab03_01_exe_regShot.png)

<br/><br/>

### 3. Are there any useful network-based signatures for this malware? If so, what are they?

The malware seems to be requesting DNS requests from www.practicalmalwareanalysis.com from the DNS server and trying to request pages from the URL.

![lab03-01 network IOC](lab03_01_exe_network.png)

<br/><br/>

## Lab 03-02

### 1. How can you get this malware to install itself?

![lab03-02 Functions export](lab03_02_dll_exports.png)

Viewing the exports of the DLL file, we can see that there's a function called installA. We could install the malware using that function. The function will create a new service called IPRIP (based on the notification shown by window XP). 

<br/><br/>

### 2. How would you get this malware to run after installation?

To run the installed malware, we need to execute the command net start IPRIP to start the service.

![lab03-02 Starting the service from the cmd](lab03_02_dll_starting_services.png)

<br/><br/>

### 3. How can you find the process under which this malware is running?

To identify where the malware is running (the process that it is running in), we can use process hackers and identify the PID of the service. Using that PID, we can identify the process that's running the malware. In this case, the malware is executing under one of the svchost.exe processes.

![lab03-02 Finding the PID of the malware using Process hacker](lab03_02_dll_finding_pid_in_process_hacker.png)

![lab03-02 Finding the process the malwware is running on using process hacker](lab03_02_dll_finding_service_parent.png)

When clicking into the process, we can see that lab03-02.dll is loaded as one of the module used by the process. 

![lab03-02 The malware is loaded in the svchost.exe modules](lab03_02_dll_finding_loaded_dll.png)

<br/><br/>

### 4. Which filters could you set in order to use procmon to glean information?

We can get all the information of the malware using the PID the malware module is running in.

<br/><br/>

### 5. What are the malware’s host-based indicators?

![lab03-02 registers keys added](lab03_02_dll_reg_keys_added.png)

![lab03-02 registers values added](lab03_02_dll_reg_values_added.png)

This malware has a display name of "Intranet Network Awareness (INA+)", service name "IPRIP", and the description of the module. The malware will also add a new key entry at "HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\Parameters\ServiceDll: {The path to the dll}". These can be used as a Host-based indicator.

<br/><br/>

### 6. Are there any useful network-based signatures for this malware?

The malware seems to be requesting HTTP requests to a domain name "http://practicalmalwareanalysis.com" for a network-based signature. It appears to be requesting a page named service.html, which returned HTTP response code 404, which means the server can't find the page.

![lab03-02 wireshark network IOC](lab03_02_dll_http_requests.png)

<br/><br/>

## Lab 03-03

### 1. What do you notice when monitoring this malware with Process Explorer?

When the binary was executed, the process created a svchost.exe process under it. But right after that, the binary terminated itself. However, the spawned svchost.exe process did not get terminated along with it. 

![lab03-03 created a svchost child process](lab03_03_svchost_exe_process_created.png)

<br/><br/>

### 2. Can you identify any live memory modifications?

Looking into a svchost.exe that was already on the system before the malware was executed, many strings were contained in the process. However, the spawned svchost process has fewer strings and contains many readable strings that induce suspicion towards them. 

![lab03-03 spawned svchost process is suspicious](lab03_03_svchost_exe_memory_differ.png)


Not to mention the suspicious strings of keyboard symbols contained in the process strings. This is an indicator that the malware is a keylogger, and these strings are used in the conditional operation of the keylogger to record keystrokes.

![lab03-03 spawned svchost process contains keyboard symbols](lab03_03_svchost_exe_strings.png)

<br/><br/>

### 3. What are the malware’s host-based indicators?

The most apparent Host-based indicator of the malware is the file "practicalmalwareanalysis.log", which was used to store the recorded keystroke performed by the keylogger. To further prove this claim, entries in the Procmon are filtered, and we can see that there are data written into the file and also, by looking into the file, we can see the keystroke we pressed before.

![lab03-03 spawned svchost process contains keyboard symbols](lab03_03_prove_keylogger.png)

<br/><br/>

### 4. What is the purpose of this program?

This malware is a keylogger, and it would perform process replacement onto the svchost.exe process that's spawned from the execution of the malware.

<br/><br/>

## Lab 03-04

On the initial investigation, we can see that the binary file is not packed.

![lab03-04 The binary is not packed](lab03_04_not_packed.png)

<br/><br/>

### 1. What happens when you run this file?

The file deleted itself upon running. No new process or services was created after it was executed when monitoring the Process Hacker entries. 

![lab03-04 The binary self delete after execution](lab03_04_file_self_delete.png)

<br/><br/>

### 2. What is causing the roadblock in dynamic analysis? 

I'm still unsure how to find a "strings" executable that can run on a 32-bit machine, so I opened it up using IDA. In researching the code execution of the malware using IDA, I noticed that the malware contains some condition statements to check for flags included when executing the malware. 

The flags are:
 - -in
 - -re
 - -c
 - -cc

![lab03-04 The binary's flags part 1](lab03_04_flags_1.png)

![lab03-04 The binary's flags part 2](lab03_04_flags_2.png)

When viewing the strings contained in the malware, we can see that the malware includes registry location "SOFTWARE\\Microsoft\\XPS" and domain names. The strings also contain words like UPLOAD and DOWNLOAD and HTTP 1.0. These strings indicate that the malware might be an HTTP backdoor.

![lab03-04 The binary's Strings](lab03_04_strings.png)

Investigating the procmon entries gave us an interesting event. There was a Process Create operation recorded by Procmon when the malware was executed. This process contains the command used by the malware to delete itself from the machine.

![lab03-04 Procmon filter to find Create Process](lab03_04_procmon_filter.png)

![lab03-04 Procmon found one Process Create operation](lab03_04_process_create_procmon.png)

<br/><br/>

### 3. Are there other ways to run this program?

Nope. Using all the flags as viewed in IDA did not trigger any new visible findings. The malware keeps deleting itself. 

<br/><br/>